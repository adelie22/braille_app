<!-- blueprints/learning/templates/learning/index.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Learning Braille</title>
    <style>
        /* Basic Styles */
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
        }
        h1 {
            color: #333;
            margin-top: 20px;
        }
        .flash.success {
            color: green;
        }
        .flash.error {
            color: red;
        }
        .flash.info {
            color: blue;
        }
        .flashes {
            list-style-type: none;
            padding: 0;
        }
        .flashes li {
            margin-bottom: 10px;
        }
        .word-display, .input-display {
            margin: 20px 0;
            font-size: 1.5em;
            color: #444;
        }
        .braille-characters {
            font-family: 'SimBraille', sans-serif; /* Use a braille-friendly font if available */
            background-color: #e6e6e6;
            padding: 10px;
            border-radius: 8px;
            display: inline-block;
            min-width: 200px;
            min-height: 50px;
        }
        .braille-characters span.cursor {
            background-color: yellow; /* Highlight color */
            border-radius: 4px;
        }
        .container {
            max-width: 600px;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 40px;
            text-align: center;
        }
        audio {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Learning Braille</h1>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flashes">
              {% for category, message in messages %}
                <li class="flash {{ category }}">{{ message }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
        
        <!-- Display the Target Word -->
        {% if target_word %}
            <div class="word-display">
                <strong>Target Word:</strong> {{ target_word }}
            </div>
        {% endif %}
        
        <!-- Display User's Input -->
        <div class="input-display">
            <strong>Your Input:</strong>
            <div id="user-input" class="braille-characters"></div>
        </div>
        <!-- Instruction -->
        <p>Translate the braille input to match the target word.</p>

        <!-- Feedback Audio (e.g., "Correct!" or "Incorrect...") -->
        <audio id="feedback-audio" {% if feedback_audio_url %}src="{{ feedback_audio_url }}"{% endif %} autoplay></audio>
        
        <!-- Word Audio -->
        {% if audio_url %}
            <audio id="word-audio" src="{{ audio_url }}" autoplay></audio>
        {% endif %}
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let formSubmitting = false;
            let lastDisplayBuffer = [];
            let lastCursorPosition = 0;

            function fetchInputBuffer() {
                if (formSubmitting) return;
                fetch('/learning/get_current_input_buffer')
                    .then(response => response.json())
                    .then(data => {
                        const inputBuffer = data.input_buffer;
                        const cursorPosition = data.cursor_position;
                        const controlSignal = data.control_signal;
                        console.log('Received input buffer:', inputBuffer);
                        console.log('Received cursor position:', cursorPosition);
                        console.log('Received control signal:', controlSignal);

                        // Check if inputBuffer or cursorPosition is different from lastDisplayBuffer and lastCursorPosition
                        if (JSON.stringify(inputBuffer) !== JSON.stringify(lastDisplayBuffer) || cursorPosition !== lastCursorPosition) {
                            lastDisplayBuffer = inputBuffer.slice(); // Create a copy
                            lastCursorPosition = cursorPosition;
                            updateUserInputDisplay(lastDisplayBuffer, lastCursorPosition);
                        }

                        // Handle control signals
                        if (['Enter', 'Back', 'Ctrl+Enter', 'Ctrl+Backspace', 'Left', 'Right', 'Up', 'Down', 
                        'Ctrl', 'Space', 'Ctrl + Up', 'Ctrl + Down', 'Ctrl + Space'].includes(controlSignal)) {
                            console.log(`Control signal detected: ${controlSignal}`);
                            formSubmitting = true;
                            // Submit a hidden form to trigger the POST method
                            var form = document.createElement('form');
                            form.method = 'POST';
                            form.action = '/learning/';
                            document.body.appendChild(form);
                            form.submit();
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching input buffer:', error);
                    });
            }

            function updateUserInputDisplay(inputBuffer, cursorPosition) {
                console.log(`Updating display. Buffer: ${inputBuffer}, Cursor: ${cursorPosition}`);
                const userInputDisplay = document.getElementById('user-input');
                if (userInputDisplay) {
                    userInputDisplay.innerHTML = ''; // Clear current display
                    inputBuffer.forEach((binaryStr, index) => {
                        let brailleValue = 0;
                        for (let i = 0; i < 6; i++) {
                            const bit = binaryStr[5 - i];  // Reverse order of bits
                            if (bit === '1') {
                                brailleValue |= (1 << i);
                            }
                        }
                        const brailleChar = String.fromCharCode(0x2800 + brailleValue);
                        const span = document.createElement('span');
                        span.textContent = brailleChar;
                        if (index === cursorPosition) {
                            span.classList.add('cursor');
                            console.log(`Cursor is at position: ${index}`);
                        }
                        userInputDisplay.appendChild(span);
                    });
                    console.log('User input display updated.');
                }
            }

            // Periodically fetch the input buffer
            setInterval(fetchInputBuffer, 500); // Fetch every 0.5 second

            // Function to handle audio autoplay
            function handleAudioAutoplay(audioElement) {
                if (audioElement) {
                    var playPromise = audioElement.play();
                    if (playPromise !== undefined) {
                        playPromise.then(_ => {
                            console.log(`${audioElement.id} playback started.`);
                        })
                        .catch(error => {
                            console.error(`Autoplay was prevented for ${audioElement.id}:`, error);
                        });
                    }
                }
            }
            // Handle Word Audio Autoplay
            var wordAudio = document.getElementById('word-audio');
            handleAudioAutoplay(wordAudio);

            // Handle Feedback Audio Autoplay
            var feedbackAudio = document.getElementById('feedback-audio');
            handleAudioAutoplay(feedbackAudio);
        });
    </script>
</body>
</html>
