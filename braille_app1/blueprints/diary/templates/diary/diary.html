<!-- blueprints/diary/templates/diary/diary.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Diary Section</title>
    <style>
        /* Basic Styles */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #fafafa;
            text-align: center;
        }
        .diary-list {
            max-width: 800px;
            margin: 20px auto;
            text-align: left;
        }
        .diary-item, #create-new-diary {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #fff;
            cursor: pointer;
            position: relative;
            outline: none;
        }
        .diary-item:hover, #create-new-diary:hover {
            background-color: #f0f0f0;
        }
        .diary-date {
            font-size: 18px;
            font-weight: bold;
        }
        #create-new-diary {
            background-color: #28a745;
            color: #fff;
            font-size: 20px;
            transition: background-color 0.3s;
        }
        #create-new-diary:hover {
            background-color: #218838;
        }
        /* Highlight selected item */
        .selected {
            background-color: #e5e75f !important;
            border: 2px solid #dde74d;
        }
        /* Status Message */
        #status-message {
            margin-top: 20px;
            font-size: 1.2em;
            color: red;
        }
    </style>
</head>
<body>
    <h1>Diary Section</h1>
    
    <!-- Create New Diary Button -->
    <button id="create-new-diary" aria-label="Create New Diary" tabindex="0">Create New Diary</button>
    
    <!-- List of Existing Diaries -->
    <div class="diary-list" id="diary-list">
        {% for diary in diaries %}
            <div class="diary-item" 
                 data-id="{{ diary.id }}" 
                 data-date="{{ diary.date.strftime('%Y-%m-%d %H:%M:%S') }}" 
                 tabindex="0">
                <div class="diary-date">
                    {{ diary.date.strftime('%Y-%m-%d %H:%M:%S') }}
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Status Message -->
    <div id="status-message" aria-live="polite"></div>
    
    <!-- External JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Define navigation index
            // currentIndex: 0 = Create New Diary, 1 to N = diary entries
            let currentIndex = 0;
            const diaryList = document.getElementById('diary-list');
            const diaryItems = diaryList.querySelectorAll('.diary-item');
            const createNewDiaryBtn = document.getElementById('create-new-diary');
            let totalItems = diaryItems.length + 1; // +1 for Create New Diary
            const statusMessage = document.getElementById('status-message');
            
            // Speech synthesis control
            let isSpeaking = false;

            // Function to get the currently focused element based on currentIndex
            function getCurrentElement() {
                if (currentIndex === 0) {
                    return createNewDiaryBtn;
                } else {
                    return diaryItems[currentIndex - 1];
                }
            }

            // Function to clear all highlights
            function clearHighlights() {
                createNewDiaryBtn.classList.remove('selected');
                diaryItems.forEach(item => item.classList.remove('selected'));
            }

            // Function to update selection and handle speech
            function updateSelection() {
                clearHighlights();
                const currentElement = getCurrentElement();
                currentElement.classList.add('selected');
                currentElement.focus();
                
                if (currentIndex === 0) {
                    // "Create New Diary" selected
                    speakMessage('Create New Diary', 'en-US');
                } else {
                    // Diary entry selected
                    const diaryDate = currentElement.dataset.date;
                    speakMessage(`Diary from ${diaryDate}`, 'en-US');
                }
            }

            // Function to speak messages in specified language
            function speakMessage(message, lang) {
                console.log(`Speaking message: "${message}" in language: ${lang}`);
                if (isSpeaking) {
                    window.speechSynthesis.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(message);
                utterance.lang = lang; // Set language
                
                // Select a voice that matches the language
                const voices = window.speechSynthesis.getVoices();
                const matchedVoice = voices.find(voice => voice.lang === lang);
                if (matchedVoice) {
                    utterance.voice = matchedVoice;
                } else {
                    console.warn(`No voice found for language: ${lang}. Using default voice.`);
                }
                
                utterance.onstart = () => { isSpeaking = true; };
                utterance.onend = () => { isSpeaking = false; };
                window.speechSynthesis.speak(utterance);
            }

            // Function to activate the selected item
            function activateSelectedItem() {
                const currentElement = getCurrentElement();
                if (currentIndex === 0) {
                    // Navigate to Create New Diary
                    navigateToDiaryContent();
                } else {
                    const diaryId = currentElement.dataset.id;
                    navigateToDiaryContent(diaryId);
                }
            }

            // Function to navigate to diary content page
            function navigateToDiaryContent(diaryId = null) {
                if (diaryId) {
                    window.location.href = `/diary/content?revise=${diaryId}`;
                } else {
                    window.location.href = `/diary/content`;
                }
            }

            // Function to read diary content via speech synthesis
            function readDiaryContent(diaryId) {
                fetch(`/diary/read/${diaryId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.content) {
                            speakMessage(data.content, 'en-US');
                        } else {
                            speakMessage('Diary content is empty.', 'en-US');
                        }
                    })
                    .catch(error => {
                        console.error('Error reading diary:', error);
                        speakMessage('Failed to read diary.', 'en-US');
                    });
            }

            // Function to delete a diary entry
            function deleteDiary(diaryId) {
                if (confirm('Are you sure you want to delete this diary?')) {
                    fetch(`/diary/delete/${diaryId}`, {
                        method: 'DELETE',
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.message) {
                            speakMessage(data.message, 'en-US');
                            // Remove the diary from the list
                            const diaryElement = document.querySelector(`.diary-item[data-id='${diaryId}']`);
                            if (diaryElement) {
                                diaryElement.remove();
                                // Update indices and totalItems
                                currentIndex = currentIndex > 0 ? currentIndex - 1 : 0;
                                // Recalculate totalItems
                                totalItems = diaryList.querySelectorAll('.diary-item').length + 1;
                                updateSelection();
                            }
                        } else if (data.error) {
                            speakMessage(data.error, 'en-US');
                        }
                    })
                    .catch(error => {
                        console.error('Error deleting diary:', error);
                        speakMessage('Failed to delete diary.', 'en-US');
                    });
                }
            }

            // Handle Braille Keyboard Signals
            function handleBrailleSignal(signal) {
                console.log('Received signal:', signal);
                switch(signal) {
                    case 'Up':
                        if (currentIndex > 0) {
                            currentIndex--;
                            updateSelection();
                        }
                        break;
                    case 'Down':
                        if (currentIndex < totalItems -1) {
                            currentIndex++;
                            updateSelection();
                        }
                        break;
                    case 'Ctrl+Space':
                        handleCtrlSpace();
                        break;
                    case 'Ctrl+Left':
                        handleCtrlLeft();
                        break;
                    case 'Enter':
                        activateSelectedItem();
                        break;
                    default:
                        console.warn(`Unhandled signal: ${signal}`);
                }
            }

            // Function to handle 'Ctrl+Space' signal
            function handleCtrlSpace() {
                if (currentIndex === 0) {
                    // No action for "Create New Diary"
                    speakMessage('Create New Diary. No content to read.', 'en-US');
                    return;
                }
                const currentElement = getCurrentElement();
                const diaryId = currentElement.dataset.id;
                readDiaryContent(diaryId);
            }

            // Function to handle 'Ctrl+Left' signal
            function handleCtrlLeft() {
                if (currentIndex === 0) {
                    // No action for "Create New Diary"
                    speakMessage('Create New Diary. No diary to delete.', 'en-US');
                    return;
                }
                const currentElement = getCurrentElement();
                const diaryId = currentElement.dataset.id;
                deleteDiary(diaryId);
            }

            // Poll the backend for Braille signals and dispatch events
            function pollBrailleSignals() {
                fetch('/diary/get_braille_signals')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const brailleSignals = data.braille_signals;
                        const controlSignals = data.control_signals;
                        
                        // Handle Control Signals
                        controlSignals.forEach(signal => {
                            handleBrailleSignal(signal);
                        });
                    })
                    .catch(error => {
                        console.error('Error polling Braille signals:', error);
                    });
            }
            
            // Initial selection
            updateSelection();
            
            // Poll Braille signals every 500ms
            setInterval(pollBrailleSignals, 500);
        });
    </script>
</body>
</html>
